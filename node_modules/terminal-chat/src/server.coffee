_ = require "underscore"

module.exports = (argv) ->

	users = {}
	io = require("socket.io").listen argv.port,
		"log level": 2
		"log colors": false

	io.sockets.on 'connection', (socket) ->
		socket.emit "welcome", { users: users }

		socket.on "user.register", (data) ->
			unless _.isObject(data) and data.name then return socket.emit "user.error", "Username is invalid. Please try a different one."
			if _.contains _.pluck(users, "name"), data.name then return socket.emit "user.error", "Username already exists in the system. Please try a different one."
			
			data.id = socket.id
			users[socket.id] = data
			
			socket.emit "user.success"
			socket.broadcast.emit "user.add", data

		socket.on "send", (data) ->
			socket.broadcast.emit "receive", data

		socket.on 'disconnect', () ->
			delete users[socket.id]
			socket.broadcast.emit "user.remove", socket.id