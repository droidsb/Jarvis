_ = require "underscore"
require "sugar"
clc = require "cli-color"
fs = require "fs"
path = require "path"

# name the process
process.title = "tchat"

# catch everything
process.on "uncaughtException", (err) ->
	console.log err.stack
	#console.log clc.cyan(Date.create().format("[{h}:{mm}{tt}] ")) + clc.red.inverse("Error") + " " + err.message
	process.exit 0

# hard defaults
dargv =
	host: "localhost"
	port: 3330
	user: "user-#{Math.floor(Math.random()*8999)+1000}"
	color: "black"
	silent: false
	sound: "ping"

program = require("optimist")
	.usage('Usage: tchat [connect|start|config] [options]')
	.option('h', {
		alias: 'host',
		describe: "The host or ip address to connect to."
	})
	.options('p', {
		alias: 'port',
		describe: "The port socket.io is listening on."
	})
	.options('u', {
		alias: 'user',
		describe: "Your in chat username."
	})
	.options('c', {
		alias: 'color',
		describe: "Your in chat color."
	})
	.options('s', {
		alias: 'silent',
		#boolean: true,
		describe: "Disable sounds and mac notifications."
	})
	.options('x', {
		alias: 'sound',
		describe: "The mac sound to play when receiving messages."
	})
	.options('l', {
		alias: 'list',
		boolean: true,
		default: false,
		describe: "List saved config values."
	})
	.options('remove', {
		boolean: true,
		default: false,
		describe: "Remove saved config values and reset them to defaults."
	})
	.options('config', {
		default: "/etc/tchat.json",
		describe: "The configuration file location."
	})
	.options('v', {
		alias: 'version',
		describe: "Show the version number."
	})

config = require("../lib/config")
argv = program.argv
command = (argv._[0] || "").toLowerCase()

# load config
cargv = config.load(argv.config)
_.defaults argv, cargv, dargv

# version
if argv.version
	pj = JSON.parse fs.readFileSync path.resolve(__dirname, "../package.json"), "utf-8"
	console.log "terminal-chat v#{pj.version}"
	process.exit(1)

# Go!
switch command
	when "connect" then require("../lib/client")(argv)
	when "start" then require("../lib/server")(argv)
	when "config" then config(argv)
	else
		console.log ""
		console.log program.help()
		console.log "Actions:"
		console.log "  connect   Connect to an tchat server."
		console.log "  start     Start a new, local tchat server."
		console.log "  config    Save options to a global configuration file."
		console.log ""