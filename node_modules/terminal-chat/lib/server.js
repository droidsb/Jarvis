// Generated by CoffeeScript 1.6.2
(function() {
  var _;

  _ = require("underscore");

  module.exports = function(argv) {
    var io, users;

    users = {};
    io = require("socket.io").listen(argv.port, {
      "log level": 2,
      "log colors": false
    });
    return io.sockets.on('connection', function(socket) {
      socket.emit("welcome", {
        users: users
      });
      socket.on("user.register", function(data) {
        if (!(_.isObject(data) && data.name)) {
          return socket.emit("user.error", "Username is invalid. Please try a different one.");
        }
        if (_.contains(_.pluck(users, "name"), data.name)) {
          return socket.emit("user.error", "Username already exists in the system. Please try a different one.");
        }
        data.id = socket.id;
        users[socket.id] = data;
        socket.emit("user.success");
        return socket.broadcast.emit("user.add", data);
      });
      socket.on("send", function(data) {
        return socket.broadcast.emit("receive", data);
      });
      return socket.on('disconnect', function() {
        delete users[socket.id];
        return socket.broadcast.emit("user.remove", socket.id);
      });
    });
  };

}).call(this);
