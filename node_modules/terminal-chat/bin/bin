#!/usr/bin/env node

// Generated by CoffeeScript 1.6.2
(function() {
  var argv, cargv, clc, command, config, dargv, fs, path, pj, program, _;

  _ = require("underscore");

  require("sugar");

  clc = require("cli-color");

  fs = require("fs");

  path = require("path");

  process.title = "tchat";

  process.on("uncaughtException", function(err) {
    console.log(err.stack);
    return process.exit(0);
  });

  dargv = {
    host: "localhost",
    port: 3330,
    user: "user-" + (Math.floor(Math.random() * 8999) + 1000),
    color: "black",
    silent: false,
    sound: "ping"
  };

  program = require("optimist").usage('Usage: tchat [connect|start|config] [options]').option('h', {
    alias: 'host',
    describe: "The host or ip address to connect to."
  }).options('p', {
    alias: 'port',
    describe: "The port socket.io is listening on."
  }).options('u', {
    alias: 'user',
    describe: "Your in chat username."
  }).options('c', {
    alias: 'color',
    describe: "Your in chat color."
  }).options('s', {
    alias: 'silent',
    describe: "Disable sounds and mac notifications."
  }).options('x', {
    alias: 'sound',
    describe: "The mac sound to play when receiving messages."
  }).options('l', {
    alias: 'list',
    boolean: true,
    "default": false,
    describe: "List saved config values."
  }).options('remove', {
    boolean: true,
    "default": false,
    describe: "Remove saved config values and reset them to defaults."
  }).options('config', {
    "default": "/etc/tchat.json",
    describe: "The configuration file location."
  }).options('v', {
    alias: 'version',
    describe: "Show the version number."
  });

  config = require("../lib/config");

  argv = program.argv;

  command = (argv._[0] || "").toLowerCase();

  cargv = config.load(argv.config);

  _.defaults(argv, cargv, dargv);

  if (argv.version) {
    pj = JSON.parse(fs.readFileSync(path.resolve(__dirname, "../package.json"), "utf-8"));
    console.log("terminal-chat v" + pj.version);
    process.exit(1);
  }

  switch (command) {
    case "connect":
      require("../lib/client")(argv);
      break;
    case "start":
      require("../lib/server")(argv);
      break;
    case "config":
      config(argv);
      break;
    default:
      console.log("");
      console.log(program.help());
      console.log("Actions:");
      console.log("  connect   Connect to an tchat server.");
      console.log("  start     Start a new, local tchat server.");
      console.log("  config    Save options to a global configuration file.");
      console.log("");
  }

}).call(this);
